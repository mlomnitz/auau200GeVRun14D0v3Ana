#include <cmath>

#include "StEventMixerHists.h"
#include "StMixerPair.h"

ClassImp(StEventMixerHists);

StEventMixerHists::StEventMixerHists(char* fileBaseName):
   mSE_Vtx(NULL), mME_Vtx(NULL), mSE_LS(NULL), mSE_US(NULL),
   mME_LS(NULL), mME_US(NULL), 
   //QA
   //foreground
   mSE_US_PointingAngle(NULL), mSE_US_DecayL(NULL), mSE_US_Dca12(NULL), 
   mSE_US_PionDca2Vtx(NULL), mSE_US_KaonDca2Vtx(NULL), mSE_US_D0Dca2Vtx(NULL),
   //likesign background
   mSE_LS_PointingAngle(NULL), mSE_LS_DecayL(NULL), mSE_LS_Dca12(NULL), 
   mSE_LS_PionDca2Vtx(NULL), mSE_LS_KaonDca2Vtx(NULL), mSE_LS_D0Dca2Vtx(NULL),
   //Mixed event
   mME_US_PointingAngle(NULL), mME_US_DecayL(NULL), mME_US_Dca12(NULL), 
   mME_US_PionDca2Vtx(NULL), mME_US_KaonDca2Vtx(NULL), mME_US_D0Dca2Vtx(NULL)
{
   mSE_Vtx = new TH2F(Form("%s_seVtx", fileBaseName), "Vertex pos;vertex x;vertex y", 250, -2.5, 2.5, 250, -2.5, 2.5);
   mME_Vtx = new TH2F(Form("%s_meVtx", fileBaseName), "Vertex pos;vertex x;vertex y", 250, -2.5, 2.5, 250, -2.5, 2.5);

   mSE_LS = new TH2F(Form("%s_se_ls_mass", fileBaseName), "Same Event LS pair Invariant mass(K#pi);p_{T}(K#pi)(GeV/c);Mass_{K#pi}(GeV/c^{2})", 150, 0, 15, 250, 0, 2.5);
   mSE_US = new TH2F(Form("%s_se_us_mass", fileBaseName), "Same Event US pair Invariant mass(K#pi);p_{T}(K#pi)(GeV/c);Mass_{K#pi}(GeV/c^{2})", 150, 0, 15, 250, 0, 2.5);
   mME_LS = new TH2F(Form("%s_me_ls_mass", fileBaseName), "Mixed Event LS pair Invariant mass(K#pi);p_{T}(K#pi)(GeV/c);Mass_{K#pi}(GeV/c^{2})", 150, 0, 15, 250, 0, 2.5);
   mME_US = new TH2F(Form("%s_me_us_mass", fileBaseName), "Mixed Event US pair Invariant mass(K#pi);p_{T}(K#pi)(GeV/c);Mass_{K#pi}(GeV/c^{2})", 150, 0, 15, 250, 0, 2.5);
   //QA Foreground
   mSE_US_PointingAngle = new TH2F(Form("%s_se_us_pointingangle",fileBaseName),"Same Event US pointing angle; p_{T} (GeV/c)",150, 0, 15,1000,0,1.0);
   mSE_US_DecayL = new TH2F(Form("%s_se_us_decayL",fileBaseName),"Same Event US Decay Length; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   mSE_US_Dca12 = new TH2F(Form("%s_se_us_dcaDaughters",fileBaseName),"Same Event US dca daughters; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   mSE_US_PionDca2Vtx = new TH2F(Form("%s_se_us_pionDca",fileBaseName),"Same Event #pi dca 2 vertex; p_{T} (GeV/c)",150, 0, 15,100,0,1.);
   mSE_US_KaonDca2Vtx = new TH2F(Form("%s_se_us_kaonDca",fileBaseName),"Same Event US K dca 2 vertex; p_{T} (GeV/c)",150, 0, 15,100,0,1.);
   mSE_US_D0Dca2Vtx = new TH2F(Form("%s_se_us_D0Dca2Vtx",fileBaseName),"SameEvent US D0 dca 2 vertex; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   //
   mSE_LS_PointingAngle = new TH2F(Form("%s_se_ls_pointingangle",fileBaseName),"Same Event LS pointing angle; p_{T} (GeV/c)",150, 0, 15,1000,0,1.0);
   mSE_LS_DecayL = new TH2F(Form("%s_se_ls_decayL",fileBaseName),"Same Event LS Decay Length; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   mSE_LS_Dca12 = new TH2F(Form("%s_se_ls_dcaDaughters",fileBaseName),"Same Event LS dca daughters; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   mSE_LS_PionDca2Vtx = new TH2F(Form("%s_se_ls_pionDca",fileBaseName),"Same Event #pi dca 2 vertex; p_{T} (GeV/c)",150, 0, 15,100,0,1.);
   mSE_LS_KaonDca2Vtx= new TH2F(Form("%s_se_ls_kaonDca",fileBaseName),"Same Event LS K dca 2 vertex; p_{T} (GeV/c)",150, 0, 15,100,0,1.);
   mSE_LS_D0Dca2Vtx = new TH2F(Form("%s_se_ls_D0Dca2Vtx",fileBaseName),"SameEvent LS D0 dca 2 vertex; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   //
   mME_US_PointingAngle = new TH2F(Form("%s_me_us_pointingangle",fileBaseName),"Same Event US pointing angle ; p_{T} (GeV/c)",150, 0, 15,1000,0,1.0);
   mME_US_DecayL = new TH2F(Form("%s_me_us_decayL",fileBaseName),"Same Event US Decay Length ; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   mME_US_Dca12 = new TH2F(Form("%s_me_us_dcaDaughters",fileBaseName),"Same Event US dca daughters ; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   mME_US_PionDca2Vtx = new TH2F(Form("%s_me_us_pionDca",fileBaseName),"Same Event #pi dca 2 vertex ; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   mME_US_KaonDca2Vtx= new TH2F(Form("%s_me_us_kaonDca",fileBaseName),"Same Event US K dca 2 vertex ; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   mME_US_D0Dca2Vtx = new TH2F(Form("%s_me_us_D0Dca2Vtx",fileBaseName),"SameEvent US D0 dca 2 vertex ; p_{T} (GeV/c)",150, 0, 15,100,0,0.1);
   return;
}
StEventMixerHists::~StEventMixerHists()
{
   delete mSE_Vtx ;
   delete mME_Vtx ;
   delete mSE_LS ;
   delete mSE_US ;
   delete mME_LS ;
   delete mME_US ;
   //QA hists
   delete mSE_US_PointingAngle;
   delete mSE_US_DecayL;
   delete mSE_US_Dca12;
   delete mSE_US_PionDca2Vtx;
   delete mSE_US_KaonDca2Vtx;
   delete mSE_US_D0Dca2Vtx;
   //
   delete mSE_LS_PointingAngle;
   delete mSE_LS_DecayL;
   delete mSE_LS_Dca12;
   delete mSE_LS_PionDca2Vtx;
   delete mSE_LS_KaonDca2Vtx;
   delete mSE_LS_D0Dca2Vtx;
   //
   delete mME_US_PointingAngle;
   delete mME_US_DecayL;
   delete mME_US_Dca12;
   delete mME_US_PionDca2Vtx;
   delete mME_US_KaonDca2Vtx;
   delete mME_US_D0Dca2Vtx;
}
void StEventMixerHists::closeFile()
{
   mSE_Vtx->Write();
   mME_Vtx->Write();
   mSE_LS->Write();
   mSE_US->Write();
   mME_LS->Write();
   mME_US->Write();
      //QA hists
   mSE_US_PointingAngle->Write();
   mSE_US_DecayL->Write();
   mSE_US_Dca12->Write();
   mSE_US_PionDca2Vtx->Write();
   mSE_US_KaonDca2Vtx->Write();
   mSE_US_D0Dca2Vtx->Write();
   //
   mSE_LS_PointingAngle->Write();
   mSE_LS_DecayL->Write();
   mSE_LS_Dca12->Write();
   mSE_LS_PionDca2Vtx->Write();
   mSE_LS_KaonDca2Vtx->Write();
   mSE_LS_D0Dca2Vtx->Write();
   //
   mME_US_PointingAngle->Write();
   mME_US_DecayL->Write();
   mME_US_Dca12->Write();
   mME_US_PionDca2Vtx->Write();
   mME_US_KaonDca2Vtx->Write();
   mME_US_D0Dca2Vtx->Write();
   
   return;
}
// QA histogram filling
// --------------------------------------
void StEventMixerHists::fillMixedEvtQADist(StMixerPair const&  pair)
{
  int ptIndex;
  for (int i = 0; i < mxeCuts::nPtBins; i++){
    if ((pair.pt() >= mxeCuts::PtEdge[i]) && (pair.pt() < mxeCuts::PtEdge[i + 1])){
      ptIndex = i;
      break;
    }
  }
  if( pair.m() <  mxeCuts::massMin || pair.m() > mxeCuts::massMax ) return;
  
  //Cos theta
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      //std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mME_US_PointingAngle->Fill(pair.pt(),std::cos(pair.pointingAngle()));
  
  //DecayL
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      //pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mME_US_DecayL->Fill(pair.pt(),pair.decayLength());

  //DcaDaughter
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      //pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mME_US_Dca12->Fill(pair.pt(),pair.dcaDaughters());
  
  //PionDca
  if( //pair.particle1Dca() > mxeCuts::pDca[ptIndex] && 
      pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mME_US_PionDca2Vtx->Fill(pair.pt(),pair.particle1Dca());

  //Kaon Dca
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && 
      //pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mME_US_KaonDca2Vtx->Fill(pair.pt(),pair.particle2Dca());
  
  //D0 dca 
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex]
      )
    mME_US_D0Dca2Vtx->Fill(pair.pt(), (pair.decayLength()) * sin(pair.pointingAngle()) );
}
// --------------------------------------
void StEventMixerHists::fillSameEvt_US_QADist(StMixerPair const&  pair)
{
  int ptIndex;
  for (int i = 0; i < mxeCuts::nPtBins; i++){
    if ((pair.pt() >= mxeCuts::PtEdge[i]) && (pair.pt() < mxeCuts::PtEdge[i + 1])){
      ptIndex = i;
      break;
    }
  }
  if( pair.m() <  mxeCuts::massMin || pair.m() > mxeCuts::massMax ) return;
  
  //Cos theta
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      //std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mSE_US_PointingAngle->Fill(pair.pt(),std::cos(pair.pointingAngle()));
  
  //DecayL
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      //pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mSE_US_DecayL->Fill(pair.pt(),pair.decayLength());

  //DcaDaughter
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      //pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mSE_US_Dca12->Fill(pair.pt(),pair.dcaDaughters());
  
  //PionDca
  if( //pair.particle1Dca() > mxeCuts::pDca[ptIndex] && 
      pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mSE_US_PionDca2Vtx->Fill(pair.pt(),pair.particle1Dca());

  //Kaon Dca
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && 
      //pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mSE_US_KaonDca2Vtx->Fill(pair.pt(),pair.particle2Dca());
  
  //D0 dca 
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex]
      )
    mSE_US_D0Dca2Vtx->Fill(pair.pt(), (pair.decayLength()) * sin(pair.pointingAngle()) );
}
// --------------------------------------
void StEventMixerHists::fillSameEvt_LS_QADist(StMixerPair const&  pair)
{
  int ptIndex;
  for (int i = 0; i < mxeCuts::nPtBins; i++){
    if ((pair.pt() >= mxeCuts::PtEdge[i]) && (pair.pt() < mxeCuts::PtEdge[i + 1])){
      ptIndex = i;
      break;
    }
  }
  if( pair.m() <  mxeCuts::massMin || pair.m() > mxeCuts::massMax ) return;
  
  //Cos theta
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      //std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mSE_LS_PointingAngle->Fill(pair.pt(),std::cos(pair.pointingAngle()));
  
  //DecayL
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      //pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mSE_LS_DecayL->Fill(pair.pt(),pair.decayLength());

  //DcaDaughter
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      //pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mSE_LS_Dca12->Fill(pair.pt(),pair.dcaDaughters());
  
  //PionDca
  if( //pair.particle1Dca() > mxeCuts::pDca[ptIndex] && 
      pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mSE_LS_PionDca2Vtx->Fill(pair.pt(),pair.particle1Dca());

  //Kaon Dca
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && 
      //pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex] &&
      ((pair.decayLength()) * sin(pair.pointingAngle())) < mxeCuts::dcaV0ToPv[ptIndex] )
    mSE_LS_KaonDca2Vtx->Fill(pair.pt(),pair.particle2Dca());
  
  //D0 dca 
  if( pair.particle1Dca() > mxeCuts::pDca[ptIndex] && pair.particle2Dca() > mxeCuts::kDca[ptIndex] &&
      pair.dcaDaughters() < mxeCuts::dcaDaughters[ptIndex] &&
      pair.decayLength() > mxeCuts::decayLength[ptIndex] &&
      std::cos(pair.pointingAngle()) > mxeCuts::cosTheta[ptIndex]
      )
    mSE_LS_D0Dca2Vtx->Fill(pair.pt(),(pair.decayLength()) * sin(pair.pointingAngle()) );
}
